# ワークロード管理 (WLM)

## WLM とは？

WLM（Workload Management）は**クエリの優先度とリソース配分を管理**する仕組み。

```
【問題】
重いバッチクエリが全リソースを占有
→ 軽いダッシュボードクエリが待たされる

【WLMで解決】
キュー1: ダッシュボード用（優先度高、軽いクエリ）
キュー2: バッチ用（優先度低、重いクエリ）
→ 軽いクエリがブロックされない
```

## WLM の仕組み

```
┌─────────────────────────────────────────────────┐
│                  クエリ受信                       │
└─────────────────────┬───────────────────────────┘
                      │
         ┌────────────┴────────────┐
         ▼                         ▼
┌─────────────────┐      ┌─────────────────┐
│   Queue 1       │      │   Queue 2       │
│   dashboard     │      │   etl           │
│                 │      │                 │
│   メモリ: 50%   │      │   メモリ: 30%   │
│   同時実行: 10  │      │   同時実行: 3   │
└─────────────────┘      └─────────────────┘
         │                         │
         └────────────┬────────────┘
                      ▼
              ┌───────────────┐
              │ Compute Nodes │
              └───────────────┘
```

## 自動 WLM vs 手動 WLM

| | 自動 WLM | 手動 WLM |
|---|---------|---------|
| メモリ配分 | Redshiftが自動 | 手動で指定 |
| 同時実行数 | 自動調整 | 固定 |
| 設定の複雑さ | シンプル | 複雑 |
| 推奨 | **ほとんどの場合これ** | 特殊要件がある場合 |

## キュー（Queue）

### キューの設定項目

| 項目 | 説明 |
|------|------|
| 名前 | キューの識別名 |
| 同時実行数 | 同時に実行できるクエリ数 |
| メモリ割合 | キューに割り当てるメモリ % |
| タイムアウト | クエリの最大実行時間 |
| ユーザーグループ | どのユーザーがこのキューを使うか |
| クエリグループ | どのクエリグループがこのキューを使うか |

### キューへのルーティング

```sql
-- ユーザーグループでルーティング
CREATE USER dashboard_user IN GROUP dashboard_group;
-- → dashboard_group用のキューに自動ルーティング

-- クエリグループでルーティング
SET query_group TO 'etl';
SELECT * FROM large_table;  -- → etl用のキューにルーティング
RESET query_group;
```

## 自動 WLM の設定

### AWS Console で設定

1. Redshiftコンソール → クラスタ → ワークロード管理
2. パラメータグループを編集
3. キューを追加/編集

### 自動 WLM のキュー例

```
Queue 1: "dashboard"
  - ユーザーグループ: dashboard_users
  - 優先度: Highest
  - 同時実行スケーリング: ON

Queue 2: "etl"
  - クエリグループ: etl
  - 優先度: Low
  - タイムアウト: 3600秒

Queue 3: "default"
  - 上記に該当しないクエリ
  - 優先度: Normal
```

## 優先度（Priority）

自動 WLM では優先度を設定できる:

| 優先度 | 説明 |
|--------|------|
| Highest | 最優先で実行 |
| High | 高優先度 |
| Normal | 通常（デフォルト） |
| Low | 低優先度 |
| Lowest | 最低優先度 |

```
Highest のクエリ → リソースを優先的に取得
Lowest のクエリ → 他のクエリが終わるまで待つ
```

## 同時実行スケーリング

クエリが多すぎる時に自動でクラスタを追加。

```
通常時:
┌──────────────┐
│ Main Cluster │ ← 3クエリ同時実行
└──────────────┘

ピーク時（同時実行スケーリングON）:
┌──────────────┐  ┌──────────────┐
│ Main Cluster │  │ Scaling      │ ← 追加クラスタで処理
└──────────────┘  │ Cluster      │
                  └──────────────┘
```

```sql
-- キューで同時実行スケーリングを有効化
-- （AWS Consoleで設定）
```

## クエリの監視

### 現在実行中のクエリ

```sql
SELECT query, pid, user_name, starttime, query_text
FROM stv_recents
WHERE status = 'Running';
```

### キューの状態

```sql
SELECT * FROM stv_wlm_query_state;
```

### キューに入っているクエリ

```sql
SELECT * FROM stv_wlm_query_queue_state;
```

## Short Query Acceleration (SQA)

短いクエリを自動的に優先実行する機能。

```
【SQAなし】
短いクエリ → 通常キューで待機 → 重いクエリの後ろで待つ

【SQAあり】
短いクエリ → 専用の高速レーンで即実行
```

```sql
-- 短いクエリの閾値を確認（秒）
SHOW max_execution_time;
```

## ベストプラクティス

1. **自動 WLM を使う** - 手動は必要な時だけ
2. **ワークロードを分類** - ダッシュボード、ETL、アドホック
3. **優先度を設定** - ダッシュボード > ETL
4. **SQA を有効化** - 短いクエリの体感速度向上
5. **同時実行スケーリング** - ピーク対策
6. **タイムアウト設定** - 暴走クエリを防ぐ

## 設定例

```
【典型的な3キュー構成】

1. Dashboard Queue
   - 優先度: Highest
   - ユーザーグループ: bi_users
   - 同時実行スケーリング: ON

2. ETL Queue
   - 優先度: Low
   - クエリグループ: etl
   - タイムアウト: 3600秒

3. Default Queue
   - 優先度: Normal
   - 上記以外のクエリ
```
