# 同時実行スケーリング (Concurrency Scaling)

## 同時実行スケーリングとは？

クエリが集中した時に**自動で追加クラスタを起動**して処理する機能。

```
【通常時】
┌──────────────┐
│ Main Cluster │ ← 全クエリを処理
└──────────────┘

【ピーク時（同時実行スケーリングON）】
┌──────────────┐  ┌──────────────┐  ┌──────────────┐
│ Main Cluster │  │ Scaling      │  │ Scaling      │
│              │  │ Cluster 1    │  │ Cluster 2    │
└──────────────┘  └──────────────┘  └──────────────┘
        ↑                ↑                ↑
        └────────────────┴────────────────┘
              クエリを分散して処理
```

## なぜ必要？

```
【問題】
朝9時: ダッシュボードに100人がアクセス
→ クエリがキューに溜まる
→ ユーザーが待たされる

【同時実行スケーリングで解決】
→ 追加クラスタが自動起動
→ クエリを並列処理
→ 待ち時間なし
```

## 仕組み

```
1. クエリがキューに溜まる
2. Redshiftが検知
3. スケーリングクラスタを起動（数秒）
4. クエリを分散実行
5. 負荷が下がったらクラスタ終了
```

## 有効化の設定

### WLM キューで有効化

```
AWS Console → Redshift → クラスタ → ワークロード管理

Queue: dashboard
  - 同時実行スケーリング: ON ← ここ
```

### 対象キューの選択

```
【有効にすべきキュー】
- ダッシュボード（ユーザーが待っている）
- アドホッククエリ（分析者が待っている）

【有効にしないキュー】
- ETLバッチ（夜間に実行、急がない）
- 定期レポート（スケジュール実行）
```

## 料金

```
【無料クレジット】
24時間ごとに、メインクラスタの1時間分のスケーリングクレジットが付与

例: dc2.large 4ノードクラスタ
→ 毎日4ノード×1時間 = 4ノード時間が無料

【無料枠を超えた場合】
通常のオンデマンド料金
```

## 制限事項

同時実行スケーリングで実行**できない**操作:

| 操作 | スケーリングクラスタ |
|------|---------------------|
| SELECT (読み取り) | ✅ 可能 |
| COPY | ❌ 不可 |
| INSERT/UPDATE/DELETE | ❌ 不可 |
| VACUUM | ❌ 不可 |
| DDL (CREATE/ALTER/DROP) | ❌ 不可 |

**読み取りクエリのみ**がスケーリングクラスタで実行される。

## 監視

### 現在のスケーリング状態

```sql
SELECT * FROM stv_concurrency_scaling_usage;
```

### スケーリング使用量の履歴

```sql
SELECT
    start_time,
    end_time,
    query_count,
    duration_seconds
FROM svcs_concurrency_scaling_usage
ORDER BY start_time DESC;
```

### どのクエリがスケーリングで実行されたか

```sql
SELECT query, queue_name, concurrency_scaling_status
FROM stl_query
WHERE concurrency_scaling_status = 'SCALED';
```

## 同時実行スケーリング vs Serverless

| | 同時実行スケーリング | Serverless |
|---|---------------------|------------|
| ベース | Provisioned クラスタ | なし |
| スケール対象 | 読み取りクエリのみ | 全クエリ |
| 起動時間 | 数秒 | 数秒 |
| 課金 | 使用時間（無料枠あり） | RPU使用量 |
| 用途 | ピーク対策 | 常時オートスケール |

## ベストプラクティス

1. **ダッシュボードキューで有効化** - ユーザー体験向上
2. **ETLキューでは無効** - 書き込みは対象外、コスト節約
3. **無料クレジットを活用** - 毎日リセットされる
4. **監視を設定** - スケーリング頻度をチェック
5. **頻繁にスケールするなら** - クラスタサイズアップを検討

## 設定例

```
【推奨構成】

Queue 1: dashboard
  - 同時実行スケーリング: ON ← 有効
  - 優先度: Highest

Queue 2: adhoc
  - 同時実行スケーリング: ON ← 有効
  - 優先度: Normal

Queue 3: etl
  - 同時実行スケーリング: OFF ← 無効（書き込みメイン）
  - 優先度: Low
```
